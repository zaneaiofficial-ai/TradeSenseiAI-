name: Build and Release Windows Installer

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore and publish WPF app (win-x64)
        run: |
          dotnet restore src/csharp_ui/TradeSensei.UI.csproj
          dotnet publish src/csharp_ui/TradeSensei.UI.csproj -c Release -r win-x64 --self-contained false

      - name: Install NSIS
        run: |
          choco install nsis -y

      - name: Build NSIS installer
        run: |
          "$env:ProgramFiles(x86)\NSIS\makensis.exe" installer\TradeSenseiAI.nsi

      - name: Upload installer to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          choco install gh -y
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
          gh --version
          gh release create ${{ github.ref_name }} --notes "TradeSensei AI release ${{ github.ref_name }}" || echo "Release exists"
          gh release upload ${{ github.ref_name }} installer/TradeSenseiAI-Setup.exe --clobber
