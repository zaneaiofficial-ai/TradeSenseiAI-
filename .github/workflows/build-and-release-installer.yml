name: Build and Release Windows Installer

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore and publish WPF app (win-x64)
        run: |
          dotnet restore src/csharp_ui/TradeSensei.UI.csproj
          dotnet publish src/csharp_ui/TradeSensei.UI.csproj -c Release -r win-x64 --self-contained false
          Write-Host "Publish output:"
          Get-ChildItem "src/csharp_ui/bin/Release/net8.0-windows/win-x64/publish" -Recurse | Select-Object FullName, Length | Format-Table -AutoSize

      - name: Install NSIS
        run: |
          choco install nsis -y
          # Fallbacks in case the main package doesn't lay down makensis
          if (-not (Test-Path "$env:ChocolateyInstall\lib\nsis\tools\makensis.exe")) {
            choco install nsis.portable -y
          }
          if (-not (Test-Path "$env:ChocolateyInstall\lib\nsis.portable\tools\makensis.exe") -and -not (Test-Path "$env:ChocolateyInstall\lib\nsis\tools\makensis.exe")) {
            choco install nsis.install -y
          }
          # Ensure PATH is fresh for subsequent steps
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
          # Log discovered Chocolatey NSIS dirs
          Get-ChildItem "$env:ChocolateyInstall\lib" -Filter "nsis*" -ErrorAction SilentlyContinue | Select-Object FullName | Format-Table -AutoSize
          # Optional: verify installation
          (Get-Command makensis -ErrorAction SilentlyContinue) | Out-String

      - name: Build NSIS installer
        run: |
          # Robust resolution of makensis across common install locations
          $exe = $null
          $cmd = Get-Command makensis -ErrorAction SilentlyContinue
          if ($cmd) { $exe = $cmd.Source }
          $pf = [System.Environment]::GetEnvironmentVariable('ProgramFiles')
          $pf86 = [System.Environment]::GetEnvironmentVariable('ProgramFiles(x86)')
          if (-not $exe -and $pf -and (Test-Path (Join-Path $pf 'NSIS\makensis.exe'))) { $exe = (Join-Path $pf 'NSIS\makensis.exe') }
          if (-not $exe -and $pf86 -and (Test-Path (Join-Path $pf86 'NSIS\makensis.exe'))) { $exe = (Join-Path $pf86 'NSIS\makensis.exe') }
          if (-not $exe -and $env:ChocolateyInstall -and (Test-Path (Join-Path $env:ChocolateyInstall 'bin\makensis.exe'))) { $exe = (Join-Path $env:ChocolateyInstall 'bin\makensis.exe') }
          if (-not $exe -and $env:ChocolateyInstall -and (Test-Path (Join-Path $env:ChocolateyInstall 'lib\nsis\tools\makensis.exe'))) { $exe = (Join-Path $env:ChocolateyInstall 'lib\nsis\tools\makensis.exe') }
          if (-not $exe -and $env:ChocolateyInstall -and (Test-Path (Join-Path $env:ChocolateyInstall 'lib\nsis.portable\tools\makensis.exe'))) { $exe = (Join-Path $env:ChocolateyInstall 'lib\nsis.portable\tools\makensis.exe') }
          if (-not $exe -and $env:ChocolateyInstall -and (Test-Path (Join-Path $env:ChocolateyInstall 'lib\nsis.install\tools\makensis.exe'))) { $exe = (Join-Path $env:ChocolateyInstall 'lib\nsis.install\tools\makensis.exe') }
          if (-not $exe) { Write-Error "makensis executable not found after install"; exit 1 }

          $pub = "src\csharp_ui\bin\Release\net8.0-windows\win-x64\publish"
          Write-Host "Using publish directory: $pub"
          if (-not (Test-Path $pub)) { Write-Error "Publish directory missing: $pub"; Get-ChildItem "src\csharp_ui\bin\Release" -Recurse | Select-Object FullName; exit 1 }
          & $exe /V4 /D PUBLISH_DIR="$pub" installer\TradeSenseiAI.nsi
          Write-Host "Built installer:" (Get-Item "installer/TradeSenseiAI-Setup.exe").FullName

      - name: Upload installer to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          choco install gh -y
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
          gh --version
          # Create the release if it doesn't exist, else continue
          gh release view ${{ github.ref_name }} || gh release create ${{ github.ref_name }} --notes "TradeSensei AI release ${{ github.ref_name }}"
          # Upload the installer asset
          gh release upload ${{ github.ref_name }} installer/TradeSenseiAI-Setup.exe --clobber
