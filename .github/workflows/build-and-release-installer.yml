name: Build and Release Windows Installer

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore and publish WPF app (win-x64)
        run: |
          dotnet restore src/csharp_ui/TradeSensei.UI.csproj
          dotnet publish src/csharp_ui/TradeSensei.UI.csproj -c Release -r win-x64 --self-contained false
          Write-Host "Publish output:"
          Get-ChildItem "src/csharp_ui/bin/Release/net8.0-windows/win-x64/publish" -Recurse | Select-Object FullName, Length | Format-Table -AutoSize

      - name: Install NSIS
        run: |
          choco install nsis -y

      - name: Build NSIS installer
        run: |
          # Use makensis from Chocolatey PATH
          $makensis = (Get-Command makensis -ErrorAction SilentlyContinue)
          if (-not $makensis) { $makensis = Get-Item "$env:ProgramFiles(x86)\NSIS\makensis.exe" }
          & $makensis installer\TradeSenseiAI.nsi
          Write-Host "Built installer:" (Get-Item "installer/TradeSenseiAI-Setup.exe").FullName

      - name: Upload installer to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          choco install gh -y
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
          gh --version
          # Create the release if it doesn't exist, else continue
          gh release view ${{ github.ref_name }} || gh release create ${{ github.ref_name }} --notes "TradeSensei AI release ${{ github.ref_name }}"
          # Upload the installer asset
          gh release upload ${{ github.ref_name }} installer/TradeSenseiAI-Setup.exe --clobber
